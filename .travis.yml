os: linux
dist: focal
language: php
cache:
  directories:
    - vendor
    - $HOME/.composer/cache
    - $HOME/.php-cs-fixer
    - $HOME/.cache/pre-commit

services:
  - docker

addons:
  firefox: latest

branches:
  except:
    - /\+travis\d+$/

jobs:
  include:
    - stage: syntax check
      php: 7.4
      before_script:
        - curl -L https://cs.symfony.com/download/php-cs-fixer-v2.phar -o php-cs-fixer.phar && chmod a+x php-cs-fixer.phar
        - curl -L https://github.com/pre-commit/pre-commit/releases/download/v2.9.3/pre-commit-2.9.3.pyz -o pre-commit && chmod a+x pre-commit
        - curl -L "https://github.com/hadolint/hadolint/releases/download/v1.17.6/hadolint-$(uname -s)-$(uname -m)" -o hadolint && chmod a+x hadolint && ls -la $HOME && cp hadolint $HOME/bin/
      script:
        - phpenv config-rm xdebug.ini || return 0
        # Check against non utf-8 files
        - scripts/check-utf8.sh .
        - ./pre-commit run --all-files

    - stage: translations
      php: 7.4
      if: branch IN (master, boly38, feature/new-theme) AND type = 'push'
      before_script:
        - wget https://getcomposer.org/composer-2.phar
        - php composer-2.phar install --ignore-platform-reqs --dev --no-interaction
      script:
        # Crowdin
        - wget --no-verbose https://artifacts.crowdin.com/repo/deb/crowdin.deb -O crowdin.deb
        - sudo dpkg -i crowdin.deb
        - sudo apt update && sudo apt install -y moreutils gettext
        - scripts/export-translations-to-crowdin.sh

    - stage: test-qa
      php: 7.4
      if: env(TRAVIS_QA_TOKEN) AND type = 'push' AND branch NOT IN (l10n_master, l10n_new-theme)
      script:
        - export PGUSER=geokrety
        - export PGPASSWORD=geokrety
        - export PGDATABASE=geokrety
        - export PGHOST=localhost
        - export PGPORT=5433
        - export DOCKER_COMPOSE="docker-compose -p gk -f docker-compose.local.yml"

        # Retrieve huge file to initialize database
        - ./website/db/get_huge_dump_files.sh

        - sudo apt-get update > /dev/null && sudo apt-get install -y postgresql-client-12 postgis httping -qq > /dev/null

        # Launch Postgres
        - ${DOCKER_COMPOSE} pull postgres
        - ${DOCKER_COMPOSE} up -d --no-build postgres

        # import SRTM subset for tests
        - timeout 60s bash -c "while ! pg_isready; do sleep 1; done"
        # - ${DOCKER_COMPOSE} logs postgres
        - ./website/db/tests-srtm-import.sh

        # Other services
        - ${DOCKER_COMPOSE} build website-base website > /dev/null
        - ${DOCKER_COMPOSE} build pictures-processor pictures-downloader pictures-uploader > /dev/null
        - ${DOCKER_COMPOSE} pull cdn redis minio svg-to-png
        - ${DOCKER_COMPOSE} up -d --no-build
        - docker ps -a

        # Wait for webserver
        - for i in $(seq 60); do httping -sGc1 -o 200,302 http://localhost:3001/ && { echo OK; break; } || ${DOCKER_COMPOSE} logs website ; sleep 1 ; done || exit 1

        # Test the database
        - sudo apt-get install -y libtap-parser-sourcehandler-pgtap-perl -qq > /dev/null
        - psql -c "CREATE DATABASE tests WITH TEMPLATE $PGDATABASE OWNER $PGUSER;"
        - PGDATABASE=tests PGOPTIONS=--search_path=public,pgtap,geokrety pg_prove -ot website/db/tests/test*.sql

#        # Seed database with initial values
#        - ${DOCKER_COMPOSE} exec website make composer-install-dev
#        - ${DOCKER_COMPOSE} exec website make seed
#
#        # Tests with PHPUnit
#        - ${DOCKER_COMPOSE} exec website make test

        - ${DOCKER_COMPOSE} exec website make test-health

        # Install RobotFramework
        - pip install -r tests-qa/requirements.txt > /dev/null

#        # Install and launch BrowserStack Local agent
#        - curl -L https://www.browserstack.com/browserstack-local/BrowserStackLocal-linux-x64.zip | gunzip > BrowserStackLocal && chmod a+x BrowserStackLocal
#        - export BS_ENABLED=1
#        - export BS_LOCAL=true
#        - export BS_LOCAL_ID="travis-${TRAVIS_BRANCH}-${TRAVIS_BUILD_NUMBER}"
#        - export BS_BUILD=${TRAVIS_BRANCH}
#        - export GEOKRETY_URL=http://bs-local.com:3000/
#        - ./BrowserStackLocal --key "${BS_TOKEN}" --verbose --daemon start --local-identifier "${BS_LOCAL_ID}" --force-local

        # Download geckodriver
        - curl -L https://github.com/mozilla/geckodriver/releases/download/v0.27.0/geckodriver-v0.27.0-linux64.tar.gz | tar xzf - -C tests-qa
        - sudo apt-get install -y ttf-bitstream-vera fonts-urw-base35 -qq > /dev/null

        # Wait for services to be reachable
        - export GEOKRETY_URL=http://localhost:3001/
        - export HEADLESS=True
        - for i in $(seq 60); do httping -sGc1 -o 200,302 "${GEOKRETY_URL}" && echo OK && break ; sleep 1 ; done
        # Launch RobotFramework testing
        - make test-qa
#        - (cd tests-qa && robot --variable browser:Firefox --output output.xml --debugfile debugfile.log --log log.html --report report.html --xunit xUnit.xml -d docs/$TRAVIS_BRANCH -V acceptance/vars/robot-vars.py acceptance/)
#        - (cd tests-qa && robot --variable browser:Chrome --output output.xml --debugfile debugfile.log --log log.html --report report.html --xunit xUnit.xml -d docs/$TRAVIS_BRANCH -V acceptance/vars/robot-vars.py acceptance/)

        # Deploy results to gh-pages
        - git clone --quiet --branch gh-pages --single-branch https://${GITHUB_TOKEN}@github.com/geokrety/geokrety-website-qa.git publish
        - cd publish &&
          cp -a ../tests-qa/docs/${TRAVIS_BRANCH} . &&
          git status &&
          git add . &&
          git config user.name  "Travis" &&
          git config user.email "travis@travis-ci.org" &&
          git commit -m "Update QA tests" &&
          git push -fq origin
        - echo QA Tests report is available at https://geokrety.github.io/geokrety-website-qa/${TRAVIS_BRANCH}/report.html

notifications:
  # doc: https://docs.travis-ci.com/user/notifications/#configuring-irc-notifications
  irc:
    channels:
      - "chat.freenode.net#geokrety"
    on_success: always
    on_failure: always
    template:
      - "%{build_url} WEBSITE %{build_number} | %{branch} - %{commit} | %{result}"
