language: php
cache:
  directories:
    - $HOME/.composer/cache/files
    - $HOME/.php-cs-fixer

branches:
  except:
    - /\+travis\d+$/

php:
  - 7.3
  - 7.4snapshot

# https://docs.travis-ci.com/user/environment-variables/#defining-multiple-variables-per-item
env:
  global:
    - GK_ENVIRONMENT=testing

matrix:
  fast_finish: true
  allow_failures:
    - php: 7.4snapshot

# https://docs.travis-ci.com/user/database-setup/#mariadb
addons:
  mariadb: '10.3'
  apt:
    packages:
      - moreutils
      - gettext

# https://andidittrich.de/2017/06/travisci-setup-mysql-tablesdata-before-running-tests.html
before_install:
  - wget --no-verbose https://artifacts.crowdin.com/repo/deb/crowdin.deb -O crowdin.deb
  - sudo dpkg -i crowdin.deb
  - mysql -u root -e 'CREATE DATABASE geokrety CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;'
  - mysql -u root -e "CREATE USER 'geokrety'@'localhost' IDENTIFIED BY 'geokrety';"
  - mysql -u root -e "GRANT ALL ON geokrety.* TO 'geokrety'@'localhost';"

install:
  - composer install --dev
  - phpenv config-rm xdebug.ini || return 0

before_script:
  - export GK_DB_DSN="mysql:host=localhost;port=3306;dbname=geokrety;charset=utf8mb4"

script:
  # Check against CRLF
  - scripts/check-crlf.sh
  # Check against trailing whitespaces on php files
  - scripts/check-trailling-spaces.sh .
  # Check against non utf-8 files
  - scripts/check-utf8.sh .
  # Check php syntax
  - scripts/phplint.sh ./website/
  # Check CS fixer
  - vendor/bin/php-cs-fixer --no-interaction --dry-run --diff -v fix
  # Install database
  - (cd website && ../vendor/bin/phinx migrate)
  # Seed database with initial values
  - (cd website && ../vendor/bin/phinx seed:run)
  # Unit tests with PHPUnit ; output to stdr to prevent session issues https://stackoverflow.com/a/38045422/944936
  - vendor/bin/phpunit --stderr
  - (cd website/public && php index.php /health)

stages:
  - name: test
  - name: deploy
    if: branch IN (master, boly38, feature/new-theme) AND type = 'push'
  - name: qaWait
    if: branch IN (feature/new-theme, feature/ntQA) AND env(TRAVIS_QA_TOKEN) AND type = 'push'
  - name: qaTests
    if: branch IN (master, boly38) AND env(TRAVIS_QA_TOKEN) AND type = 'push'

jobs:
  include:
    - stage: deploy
      script:
        - scripts/export-translations-to-crowdin.sh
    - stage: qaWait
      script:
        - bash ./scripts/app_version_wait.sh ${TRAVIS_BRANCH}
    - stage: qaTests
      script:
        # TRAVIS_QA_TOKEN from https://travis-ci.org/geokrety/geokrety-website/settings
        # TRAVIS_BRANCH   from https://docs.travis-ci.com/user/environment-variables/
        - bash ./scripts/qatests_hook.sh ${TRAVIS_QA_TOKEN} ${TRAVIS_BRANCH}
        - bash ./scripts/qatests_wait.sh ${TRAVIS_QA_TOKEN}

notifications:
  # doc: https://docs.travis-ci.com/user/notifications/#configuring-irc-notifications
  irc:
    channels:
      - "chat.freenode.net#geokrety"
    on_success: always
    on_failure: always
    template:
      - "%{build_url} WEBSITE %{build_number} | %{branch} - %{commit} | %{result}"
